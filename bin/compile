#!/bin/sh -e 

set -e

indent() {
  sed -u 's/^/       /'
}

echo "--------> Install qpdf"
BUILD_DIR=$1
VENDOR_DIR="vendor/qpdf"

echo "Creating directories..." | indent
mkdir -p "$BUILD_DIR/$VENDOR_DIR/bin"
mkdir -p /app/vendor/qpdf/bin
cd  "$BUILD_DIR/$VENDOR_DIR"


echo "Downloading binaries..." | indent
wget --quiet https://github.com/qpdf/qpdf/releases/download/release-qpdf-9.1.1/qpdf-9.1.1-x86_64.AppImage
EXPECTED_SHA="baa03b96d59caafcee41cca7f7c44870b1434a6942244e7869298bc24dcac4162672e33cc8d3f652fa644da5d05cb7c347459c3ceae7a02f25a0a8a6e8095c95"
echo "$EXPECTED_SHA qpdf-9.1.1-x86_64.AppImage" | sha512sum -c - || exit 1
mv qpdf-9.1.1-x86_64.AppImage /app/vendor/qpdf/bin
chmod +x /app/vendor/qpdf/bin
         

echo "exporting PATH and LD_LIBRARY_PATH" | indent
PROFILE_PATH="$BUILD_DIR/.profile.d/qpdf.sh"
mkdir -p $(dirname $PROFILE_PATH)
echo 'export PATH="/app/vendor/qpdf/bin:$PATH"' >> $PROFILE_PATH
